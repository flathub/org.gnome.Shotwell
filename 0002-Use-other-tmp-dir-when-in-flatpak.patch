From 3ef4ac3a02d12b1298f5e03e16c655b4b9f15363 Mon Sep 17 00:00:00 2001
From: Jens Georg <mail@jensge.org>
Date: Thu, 11 May 2023 20:26:22 +0200
Subject: [PATCH 2/2] Use other tmp dir when in flatpak

Work-around for https://github.com/flathub/org.gnome.Shotwell/issues/46
---
 src/AppDirs.vala | 17 ++++++++++++-----
 1 file changed, 12 insertions(+), 5 deletions(-)

diff --git a/src/AppDirs.vala b/src/AppDirs.vala
index 20df9207..05e172c7 100644
--- a/src/AppDirs.vala
+++ b/src/AppDirs.vala
@@ -196,14 +196,21 @@ class AppDirs {
     
     public static File get_temp_dir() {
         if (tmp_dir == null) {
-            tmp_dir = File.new_for_path(DirUtils.mkdtemp (Environment.get_tmp_dir() + "/shotwell-XXXXXX"));
+            var basedir = Environment.get_tmp_dir();
+            var flatpak_canary = File.new_for_path("/.flatpak-info");
+            if (flatpak_canary.query_exists() && basedir == "/tmp") {
+                basedir = Environment.get_user_cache_dir() + "/tmp";
+            }
+
+            tmp_dir = File.new_for_path(DirUtils.mkdtemp (basedir + "/shotwell-XXXXXX"));
             
             try {
-                if (!tmp_dir.query_exists(null))
-                    tmp_dir.make_directory_with_parents(null);
+                tmp_dir.make_directory_with_parents(null);
             } catch (Error err) {
-                AppWindow.panic(_("Unable to create temporary directory %s: %s").printf(
-                    tmp_dir.get_path(), err.message));
+                if (!(err is GLib.IOError.EXISTS)) {
+                    AppWindow.panic(_("Unable to create temporary directory %s: %s").printf(
+                        tmp_dir.get_path(), err.message));
+                }
             }
         }
         
-- 
2.40.1

